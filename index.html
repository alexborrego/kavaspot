<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>KavaSpot - Your Weekly Guide to Kava in St. Pete</title>
<meta name="description" content="Events, deals, and vibes â€” all in one place.">
<link rel="canonical" href="https://alexborrego.github.io/kavaspot/">
<link rel="stylesheet" href="styles.css">
<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@600;700&family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
<div class="app">
<header class="header">
<div class="header-content">
<div class="logo">
<div class="logo-icon">ğŸŒ¿</div>
<h1>KavaSpot</h1>
</div>
<button class="nav-btn small" onclick="showAbout()">?</button>
</div>
</header>

<div class="hero-section">
<div class="hero-content">
<span class="hero-badge">ğŸŒº St. Pete's Kava Scene</span>
<h2 class="hero-title">Find Your<br><em>Island</em> Vibes</h2>
<p class="hero-subtitle">Weekly events, exclusive deals, and hidden gems across the best kava bars in town.</p>
</div>
<div class="hero-decoration">
<span class="hero-emoji hero-emoji-1">ğŸ¥¥</span>
<span class="hero-emoji hero-emoji-2">ğŸŒº</span>
<span class="hero-emoji hero-emoji-3">ğŸŒ¿</span>
</div>
</div>

<div class="search-container">
<div class="search-box">
<span class="search-icon">ğŸ”</span>
<input type="text" placeholder="Search events, bars, deals..." id="search" oninput="handleSearch(this.value)">
</div>
</div>

<main class="main" id="mainContent">
<!-- Loading State -->
<div id="loadingState" class="loading-container">
<div class="loading-spinner"></div>
<p>Loading kava scene...</p>
</div>

<!-- Content (hidden until loaded) -->
<div id="contentArea" style="display: none;">
<!-- Events Tab -->
<div id="eventsTab">
<div class="filter-bar" id="eventFilterBar">
<select id="categoryFilter" onchange="filterEventsByCategory()">
<option value="All">All Categories</option>
</select>
</div>
<div class="featured-card" id="featuredEvent" onclick="showEvent(null)" style="display: none;">
<span class="featured-badge">â­ Featured</span>
<span class="featured-icon" id="featuredEventIcon">ğŸ¤</span>
<h3 id="featuredEventName">Loading...</h3>
<p id="featuredEventBar">...</p>
<div class="featured-meta">
<span id="featuredEventDate">ğŸ“… ...</span>
<span>ğŸ“ St. Pete</span>
</div>
</div>
<div class="event-list" id="eventList"></div>
</div>

<!-- Bars Tab -->
<div id="barsTab" style="display:none;">
<div class="filter-bar">
<select id="locationFilter" onchange="filterBarsByLocation()">
<option value="All">All Locations</option>
<option value="St. Pete">St. Pete</option>
<option value="Clearwater">Clearwater</option>
<option value="Largo">Largo</option>
</select>
</div>
<div class="bar-card featured-bar" id="featuredBar" onclick="showBar(null)" style="display: none;">
<span class="featured-badge">ğŸ† Best of the Bay</span>
<span class="featured-icon" id="featuredBarIcon">ğŸï¸</span>
<h3 id="featuredBarName">Loading...</h3>
<p id="featuredBarAddress">...</p>
<div class="bar-meta" id="featuredBarMeta">
<span>ğŸ• ...</span>
</div>
</div>
<div class="bar-list" id="barList"></div>
</div>

<!-- Deals Tab -->
<div id="dealsTab" style="display:none;">
<div class="filter-bar">
<select id="dealDayFilter" onchange="filterDealsByDay()">
<option value="All">All Days</option>
<option value="0">Sunday</option>
<option value="1">Monday</option>
<option value="2">Tuesday</option>
<option value="3">Wednesday</option>
<option value="4">Thursday</option>
<option value="5">Friday</option>
<option value="6">Saturday</option>
</select>
</div>
<div class="deal-card featured-deal" id="featuredDeal" style="display: none;">
<span class="deal-fire">ğŸ”¥</span>
<h3 id="featuredDealName">Loading...</h3>
<p id="featuredDealOffer">...</p>
<span class="deal-location" id="featuredDealBar">...</span>
<span class="deal-time" id="featuredDealTime">...</span>
</div>
<div class="deal-list" id="dealList"></div>
</div>
</div>
</main>

<section class="newsletter">
<div class="newsletter-content">
<span class="newsletter-icon">ğŸ“¬</span>
<div>
<h3>Weekly Digest</h3>
<p>Curated events, every Saturday</p>
</div>
</div>
<form class="newsletter-form" onsubmit="handleNewsletter(event)">
<input type="email" placeholder="your@email.com" required>
<button type="submit">Join</button>
</form>
</section>

<footer class="footer">
<p>KavaSpot â€¢ St. Pete + Clearwater</p>
<div class="footer-links">
<a href="#" onclick="showAbout(); return false;">About</a>
<a href="#" onclick="showForBars(); return false;">For Bars</a>
</div>
</footer>

<nav class="bottom-nav">
<button class="nav-btn active" data-tab="events" onclick="switchTab('events')"><span>ğŸ“…</span><span>Events</span></button>
<button class="nav-btn" data-tab="bars" onclick="switchTab('bars')"><span>ğŸ </span><span>Bars</span></button>
<button class="nav-btn" data-tab="deals" onclick="switchTab('deals')"><span>ğŸ</span><span>Deals</span></button>
</nav>
</div>

<!-- Event Modal -->
<div class="modal" id="eventModal" onclick="closeEventModal()">
<div class="modal-content" onclick="event.stopPropagation()">
<button class="modal-close" onclick="closeEventModal()">âœ•</button>
<div class="modal-header" id="eventModalHeader"></div>
<div class="modal-body" id="eventModalBody"></div>
</div>
</div>

<!-- Bar Modal -->
<div class="modal" id="barModal" onclick="closeBarModal()">
<div class="modal-content" onclick="event.stopPropagation()">
<button class="modal-close" onclick="closeBarModal()">âœ•</button>
<div class="modal-header bar-modal-header" id="barModalHeader"></div>
<div class="modal-body" id="barModalBody"></div>
</div>
</div>

<!-- About Modal -->
<div class="modal" id="aboutModal" onclick="closeAboutModal()">
<div class="modal-content" onclick="event.stopPropagation()">
<button class="modal-close" onclick="closeAboutModal()">âœ•</button>
<div class="modal-body about-content">
<h2>What is Kava?</h2>
<p>Kava is a traditional South Pacific beverage made from the roots of the <em>Piper methysticum</em> plant. For centuries, Pacific Island cultures have used kava in ceremonial and social settings.</p>
<p>When consumed, kava has a <strong>relaxing effect on the body</strong>, eases tension, and alleviates stress while enhancing mental clarity, creativity, and sociability. It's similar to alcohol's calming effects but without the hangover.</p>
<h3>Popular Drinks</h3>
<ul>
<li><strong>Kava Shell</strong> - Traditional preparation, served in coconut shells</li>
<li><strong>Kava Flight</strong> - Sample multiple varieties</li>
<li><strong>Botanical Elixirs</strong> - Kava mixed with herbs and flavors</li>
<li><strong>Kava Tea</strong> - Relaxing herbal tea blend</li>
</ul>
<h3>About KavaSpot</h3>
<p>We curate the best kava bars, events, and deals in St. Petersburg and Clearwater. Whether you're a kava connoisseur or trying it for the first time, we've got you covered.</p>
<p class="about-note">Please drink responsibly. Kava may cause drowsiness. Do not operate heavy machinery after consuming.</p>
</div>
</div>
</div>

<!-- For Bars Modal -->
<div class="modal" id="forBarsModal" onclick="closeForBarsModal()">
<div class="modal-content" onclick="event.stopPropagation()">
<button class="modal-close" onclick="closeForBarsModal()">âœ•</button>
<div class="modal-body about-content">
<h2>List Your Bar on KavaSpot</h2>
<p>Reach thousands of kava enthusiasts in the St. Petersburg and Clearwater area.</p>
<h3>What's Included</h3>
<ul>
<li>Free listing with hours, address, and description</li>
<li>Promote your events and specials</li>
<li>Reach a targeted local audience</li>
</ul>
<h3>Get Started</h3>
<p>Email us at <strong>hello@kavaspot.com</strong> to add your bar to our directory.</p>
</div>
</div>
</div>

<script>
// Initialize Supabase
const SUPABASE_URL = 'https://dscarhmmqxsonsxrtinx.supabase.co';
const SUPABASE_ANON_KEY = 'sb_publishable_InpeXzcHjEBfN3N6gxnxjA_NPuwIlM_';

const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

// Data stores
let barsData = [];
let eventsData = [];
let dealsData = [];
let categoriesData = [];
let barHoursData = [];

// Day mapping
const daysOfWeek = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];

async function initApp() {
try {
showLoading(true);

// Fetch all data in parallel
const [barsResult, eventsResult, dealsResult, categoriesResult, hoursResult] = await Promise.all([
supabase.from('bars').select('*').eq('is_active', true).eq('state', 'FL').order('name'),
supabase.from('events').select('*, event_categories(*)').eq('is_active', true).order('name'),
supabase.from('deals').select('*').eq('is_active', true).order('name'),
supabase.from('event_categories').select('*').order('name'),
supabase.from('bar_hours').select('*')
]);

if (barsResult.data) barsData = barsResult.data;
if (eventsResult.data) eventsData = eventsResult.data;
if (dealsResult.data) dealsData = dealsResult.data;
if (categoriesResult.data) categoriesData = categoriesResult.data;
if (hoursResult.data) barHoursData = hoursResult.data;

// Populate category filter
populateCategoryFilter();

// Render all content
renderEvents();
renderBars();
renderDeals();

// Show content, hide loading
showLoading(false);
document.getElementById('contentArea').style.display = 'block';

// Check for shareable event
checkForShareableEvent();

} catch (error) {
console.error('Error loading data:', error);
showLoading(false);
// Show error state or fallback
document.getElementById('contentArea').style.display = 'block';
document.getElementById('eventList').innerHTML = '<div class="empty-state"><span>âš ï¸</span><p>Error loading data. Please refresh.</p></div>';
}
}

function showLoading(show) {
document.getElementById('loadingState').style.display = show ? 'flex' : 'none';
}

function populateCategoryFilter() {
const select = document.getElementById('categoryFilter');
categoriesData.forEach(cat => {
const option = document.createElement('option');
option.value = cat.id;
option.textContent = `${cat.icon || 'â€¢'} ${cat.name}`;
select.appendChild(option);
});
}

function getBarById(id) {
return barsData.find(b => b.id === id);
}

function getBarHours(barId) {
return barHoursData.filter(h => h.bar_id === barId);
}

function formatHoursForBar(barId) {
const hours = getBarHours(barId);
if (!hours || hours.length === 0) return 'Hours vary';
const dayHours = {};
hours.forEach(h => {
dayHours[h.day_of_week] = h;
});
// Show today or current day's hours
const today = new Date().getDay();
const todayHours = dayHours[today];
if (todayHours && !todayHours.is_closed) {
return `${todayHours.open_time?.slice(0, 5)}-${todayHours.close_time?.slice(0, 5)}`;
}
return 'Check hours';
}

function getEventDayDisplay(event) {
if (event.is_recurring && event.recurrence_day_of_week !== null) {
return daysOfWeek[event.recurrence_day_of_week];
}
return event.event_date || 'TBD';
}

function getEventTimeDisplay(event) {
if (event.is_recurring) {
return event.recurrence_start_time?.slice(0, 5) || event.recurrence_end_time?.slice(0, 5) || 'TBD';
}
return event.event_start_time?.slice(0, 5) || event.event_end_time?.slice(0, 5) || 'TBD';
}

function renderEvents(filterCategory = 'All', search = '') {
const list = document.getElementById('eventList');
list.innerHTML = '';

let filtered = eventsData.filter(e => {
const matchesCategory = filterCategory === 'All' || e.category_id === filterCategory;
const matchesSearch = search === '' || 
e.name.toLowerCase().includes(search.toLowerCase()) || 
(e.bar_id && getBarById(e.bar_id)?.name.toLowerCase().includes(search.toLowerCase()));
return matchesCategory && matchesSearch;
});

// Find featured event (first one)
if (filtered.length > 0 && !search && filterCategory === 'All') {
const featured = filtered[0];
const bar = getBarById(featured.bar_id);
const cat = categoriesData.find(c => c.id === featured.category_id);

document.getElementById('featuredEvent').style.display = 'block';
document.getElementById('featuredEventIcon').textContent = cat?.icon || 'ğŸ“…';
document.getElementById('featuredEventName').textContent = featured.name;
document.getElementById('featuredEventBar').textContent = bar?.name || 'Unknown Bar';
document.getElementById('featuredEventDate').textContent = `ğŸ“… ${getEventDayDisplay(featured)} @ ${getEventTimeDisplay(featured)}`;
featured.showData = featured;
} else {
document.getElementById('featuredEvent').style.display = 'none';
}

filtered = filtered.slice(document.getElementById('featuredEvent').style.display !== 'none' ? 1 : 0);

if (filtered.length === 0) {
list.innerHTML = '<div class="empty-state"><span>ğŸ”</span><p>No events found</p></div>';
return;
}

filtered.forEach(event => {
const bar = getBarById(event.bar_id);
const cat = categoriesData.find(c => c.id === event.category_id);

const div = document.createElement('div');
div.className = 'event-card';
div.onclick = () => showEvent(event);
div.innerHTML = `
<div class="event-date"><span class="event-icon">${cat?.icon || 'ğŸ“…'}</span><span>${getEventDayDisplay(event)}</span></div>
<div class="event-info"><span class="event-type">${cat?.name || 'Event'}</span><span class="event-time">${getEventTimeDisplay(event)}</span><h4>${event.name}</h4><p>${bar?.name || 'Unknown Bar'}</p></div>
<button class="fav-btn" onclick="event.stopPropagation()">ğŸ¤</button>
`;
list.appendChild(div);
});
}

function renderBars(filterLocation = 'All', search = '') {
const list = document.getElementById('barList');
list.innerHTML = '';

let filtered = barsData.filter(b => {
const matchesLocation = filterLocation === 'All' || b.city === filterLocation;
const matchesSearch = search === '' || b.name.toLowerCase().includes(search.toLowerCase()) || b.address_line1?.toLowerCase().includes(search.toLowerCase());
return matchesLocation && matchesSearch;
});

// Featured bar (first one)
if (filtered.length > 0 && !search && filterLocation === 'All') {
const featured = filtered[0];
document.getElementById('featuredBar').style.display = 'block';
document.getElementById('featuredBarIcon').textContent = 'ğŸï¸';
document.getElementById('featuredBarName').textContent = featured.name;
document.getElementById('featuredBarAddress').textContent = `${featured.address_line1 || ''}, ${featured.city || ''}`;
document.getElementById('featuredBarMeta').innerHTML = `
<span>ğŸ• ${formatHoursForBar(featured.id)}</span>
<span>â˜€ï¸ ${featured.city || 'St. Pete'}</span>
`;
featured.showData = featured;
} else {
document.getElementById('featuredBar').style.display = 'none';
}

filtered = filtered.slice(document.getElementById('featuredBar').style.display !== 'none' ? 1 : 0);

filtered.forEach(bar => {
const div = document.createElement('div');
div.className = 'bar-card-mini';
div.onclick = () => showBar(bar);
div.innerHTML = `
<div class="bar-icon">ğŸ </div>
<div class="bar-info"><h4>${bar.name}</h4><p class="bar-address">${bar.address_line1?.split(',')[0] || bar.city || 'St. Pete'}</p><div class="bar-hours"><span>ğŸ• ${formatHoursForBar(bar.id)}</span></div></div>
`;
list.appendChild(div);
});
}

function renderDeals(filterDay = 'All', search = '') {
const list = document.getElementById('dealList');
list.innerHTML = '';

let filtered = dealsData.filter(d => {
const matchesDay = filterDay === 'All' || (d.recurrence_days && d.recurrence_days.includes(parseInt(filterDay)));
const matchesSearch = search === '' || 
d.name.toLowerCase().includes(search.toLowerCase()) || 
(d.bar_id && getBarById(d.bar_id)?.name.toLowerCase().includes(search.toLowerCase()));
return matchesDay && matchesSearch;
});

// Featured deal (first one)
if (filtered.length > 0 && !search && filterDay === 'All') {
const featured = filtered[0];
const bar = getBarById(featured.bar_id);
document.getElementById('featuredDeal').style.display = 'block';
document.getElementById('featuredDealName').textContent = featured.name;
document.getElementById('featuredDealOffer').textContent = featured.description || featured.name;
document.getElementById('featuredDealBar').textContent = bar?.name || 'Unknown Bar';
document.getElementById('featuredDealTime').textContent = featured.is_recurring && featured.recurrence_days 
? `Valid: ${featured.recurrence_days.map(d => daysOfWeek[d].slice(0, 3)).join(', ')}`
: 'Limited time';
featured.showData = featured;
} else {
document.getElementById('featuredDeal').style.display = 'none';
}

filtered = filtered.slice(document.getElementById('featuredDeal').style.display !== 'none' ? 1 : 0);

filtered.forEach(deal => {
const bar = getBarById(deal.bar_id);
const div = document.createElement('div');
div.className = 'deal-card-mini';
div.innerHTML = `
<div class="deal-header"><span class="deal-bar">${bar?.name || 'Unknown'}</span></div>
<h4>${deal.name}</h4>
<p class="deal-desc">${deal.description || ''}</p>
<div class="deal-meta"><span>ğŸ“ ${bar?.city || 'St. Pete'}</span><span>â° ${deal.valid_start_time?.slice(0, 5)}-${deal.valid_end_time?.slice(0, 5) || 'Close'}</span></div>
`;
list.appendChild(div);
});
}

function filterEventsByCategory() {
const category = document.getElementById('categoryFilter').value;
const search = document.getElementById('search').value;
renderEvents(category, search);
}

function filterBarsByLocation() {
const location = document.getElementById('locationFilter').value;
const search = document.getElementById('search').value;
renderBars(location, search);
}

function filterDealsByDay() {
const day = document.getElementById('dealDayFilter').value;
const search = document.getElementById('search').value;
renderDeals(day, search);
}

function handleSearch(query) {
const activeTab = document.querySelector('.nav-btn.active').dataset.tab;
if (activeTab === 'events') {
const category = document.getElementById('categoryFilter').value;
renderEvents(category, query);
} else if (activeTab === 'bars') {
const location = document.getElementById('locationFilter').value;
renderBars(location, query);
} else if (activeTab === 'deals') {
const day = document.getElementById('dealDayFilter').value;
renderDeals(day, query);
}
}

function switchTab(tab) {
document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
document.querySelector(`[data-tab="${tab}"]`).classList.add('active');
document.getElementById('eventsTab').style.display = tab === 'events' ? 'block' : 'none';
document.getElementById('barsTab').style.display = tab === 'bars' ? 'block' : 'none';
document.getElementById('dealsTab').style.display = tab === 'deals' ? 'block' : 'none';

const content = document.getElementById('subtitle');
if (content) {
content.textContent = tab === 'events' 
? `${eventsData.length} events â€¢ ${barsData.length} bars` 
: (tab === 'bars' ? `${barsData.length} bars` : `${dealsData.length} deals`);
}
}

function showEvent(event) {
if (!event) {
event = document.getElementById('featuredEvent').showData;
}
const bar = getBarById(event.bar_id);
const cat = categoriesData.find(c => c.id === event.category_id);

document.getElementById('eventModalHeader').className = 'modal-header';
document.getElementById('eventModalHeader').innerHTML = `<span class="modal-icon">${cat?.icon || 'ğŸ“…'}</span><span class="modal-type">${cat?.name || 'Event'}</span>`;
document.getElementById('eventModalBody').innerHTML = `
<h3>${event.name}</h3>
<p class="modal-bar">${bar?.name || 'Unknown Bar'}</p>
${event.description ? `<p class="modal-desc">${event.description}</p>` : ''}
<div class="modal-details">
<div><p class="detail-label">${getEventDayDisplay(event)}</p><p class="detail-time">${getEventTimeDisplay(event)}</p></div>
<div><p>ğŸ“</p><p>${bar?.address_line1 || bar?.city || 'St. Pete'}</p></div>
</div>
<div class="modal-actions">
<button class="calendar-btn" onclick="downloadICS('${event.name}','${bar?.name || ''}','${getEventDayDisplay(event)}','${getEventTimeDisplay(event)}','${bar?.address_line1 || ''}')">ğŸ“… Add to Calendar</button>
</div>
`;
document.getElementById('eventModal').style.display = 'flex';
}

function showBar(bar) {
if (!bar) {
bar = document.getElementById('featuredBar').showData;
}
const hours = getBarHours(bar.id);
const hoursText = hours.length > 0 
? hours.map(h => `${daysOfWeek[h.day_of_week].slice(0, 3)}: ${h.is_closed ? 'Closed' : `${h.open_time?.slice(0, 5)}-${h.close_time?.slice(0, 5)}`}`).join(' | ')
: 'Hours vary';

document.getElementById('barModalHeader').className = 'modal-header bar-modal-header';
document.getElementById('barModalHeader').innerHTML = `<span class="modal-icon">ğŸ </span>`;
document.getElementById('barModalBody').innerHTML = `
<h3>${bar.name}</h3>
<p class="modal-bar">${bar.city || 'St. Pete'}</p>
${bar.description ? `<p class="modal-desc">${bar.description}</p>` : ''}
<div class="modal-details">
<div><p>ğŸ“</p><p>${[bar.address_line1, bar.city, bar.state, bar.zip_code].filter(Boolean).join(', ')}</p></div>
${bar.phone ? `<div><p>ğŸ“</p><p><a href="tel:${bar.phone}">${bar.phone}</a></p></div>` : ''}
<div><p>ğŸ•</p><p>${hoursText}</p></div>
</div>
<div class="modal-actions">
${bar.website_url ? `<a href="${bar.website_url}" target="_blank" rel="noopener" class="map-btn">ğŸŒ Website</a>` : ''}
</div>
`;
document.getElementById('barModal').style.display = 'flex';
}

function downloadICS(title, location, date, time, fullLocation) {
const icsContent = `BEGIN:VCALENDAR
VERSION:2.0
BEGIN:VEVENT
SUMMARY:${title} at ${location}
DTSTART:${date.replace(/ /g, '').toUpperCase()}T${time.replace(/:/g, '')}00
DTEND:${date.replace(/ /g, '').toUpperCase()}T${time.replace(/:/g, '')}00
LOCATION:${fullLocation}
DESCRIPTION:${title} at ${location}
END:VEVENT
END:VCALENDAR`;
const blob = new Blob([icsContent], { type: 'text/calendar' });
const url = URL.createObjectURL(blob);
const a = document.createElement('a');
a.href = url;
a.download = 'kavaspot-event.ics';
a.click();
URL.revokeObjectURL(url);
}

function handleNewsletter(e) {
e.preventDefault();
const email = e.target.querySelector('input').value;
alert('Thanks for subscribing! You\'ll receive our weekly digest at ' + email);
e.target.reset();
}

function showAbout() { document.getElementById('aboutModal').style.display = 'flex'; }
function closeAboutModal() { document.getElementById('aboutModal').style.display = 'none'; }
function showForBars() { document.getElementById('forBarsModal').style.display = 'flex'; }
function closeForBarsModal() { document.getElementById('forBarsModal').style.display = 'none'; }
function closeEventModal() { document.getElementById('eventModal').style.display = 'none'; }
function closeBarModal() { document.getElementById('barModal').style.display = 'none'; }

function checkForShareableEvent() {
const params = new URLSearchParams(window.location.search);
const eventId = params.get('event');
if (eventId) {
const event = eventsData.find(e => e.id === eventId);
if (event) {
switchTab('events');
setTimeout(() => showEvent(event), 100);
}
}
}

// Initialize on load
document.addEventListener('DOMContentLoaded', initApp);
</script>
</body>
</html>
